<!DOCTYPE html>
<html>
<head>
    <title>Test formatCurrency</title>
</head>
<body>
    <h1>formatCurrency Test</h1>
    <div id="test-results"></div>

    <script type="module">
        // Simple test to verify formatCurrency works
        const testDiv = document.getElementById('test-results');

        // Create a simple version of the formatter
        const detectedLocale = navigator.language ?? 'en-UK';
        const currencyFormatterCache = new Map();

        function formatCurrency(amount, currencyCode = 'USD', decimals = 2) {
            if (isNaN(amount)) {
                return 'Invalid';
            }

            // Create cache key for the currency formatter
            const cacheKey = `${currencyCode}-${decimals}`;

            // Get or create formatter for this currency
            if (!currencyFormatterCache.has(cacheKey)) {
                try {
                    const formatter = new Intl.NumberFormat(detectedLocale, {
                        style: 'currency',
                        currency: currencyCode,
                        roundingMode: 'halfEven',
                        minimumFractionDigits: decimals,
                        maximumFractionDigits: decimals,
                    });
                    currencyFormatterCache.set(cacheKey, formatter);
                } catch {
                    // Fallback for invalid currency codes
                    const formatter = new Intl.NumberFormat(detectedLocale, {
                        style: 'currency',
                        currency: 'USD',
                        roundingMode: 'halfEven',
                        minimumFractionDigits: decimals,
                        maximumFractionDigits: decimals,
                    });
                    currencyFormatterCache.set(cacheKey, formatter);
                }
            }

            const formatter = currencyFormatterCache.get(cacheKey);
            // Convert from smallest unit (e.g., cents) to main unit (e.g., dollars)
            const divisor = Math.pow(10, decimals);
            return formatter.format(amount / divisor);
        }

        // Test various currencies
        const tests = [
            { amount: 100, currency: 'USD', decimals: 2, expected: '$1.00' },
            { amount: 12345, currency: 'USD', decimals: 2, expected: '$123.45' },
            { amount: 100, currency: 'EUR', decimals: 2, expected: '€1.00' },
            { amount: 12345, currency: 'EUR', decimals: 2, expected: '€123.45' },
            { amount: 100, currency: 'GBP', decimals: 2, expected: '£1.00' },
            { amount: 10000000, currency: 'BTC', decimals: 8, expected: '₿0.10000000' },
        ];

        let results = '<h2>Test Results:</h2>';

        tests.forEach((test, index) => {
            const result = formatCurrency(test.amount, test.currency, test.decimals);
            const passed = result.includes(test.expected.slice(-6)); // Check the numeric part

            results += `<p>Test ${index + 1}: ${test.amount} ${test.currency} (${test.decimals} decimals)<br>`;
            results += `Result: ${result}<br>`;
            results += `Status: ${passed ? '✅ PASS' : '❌ FAIL'}</p>`;
        });

        testDiv.innerHTML = results;
    </script>
</body>
</html>
